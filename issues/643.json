{
  "type": "issue",
  "issue": {
    "id": 1330721495,
    "node_id": "I_kwDOEEET9c5PUTLX",
    "url": "https://api.github.com/repos/bitcoin-core/gui/issues/643",
    "repository_url": "https://api.github.com/repos/bitcoin-core/gui",
    "labels_url": "https://api.github.com/repos/bitcoin-core/gui/issues/643/labels%7B/name%7D",
    "comments_url": "https://api.github.com/repos/bitcoin-core/gui/issues/643/comments",
    "events_url": "https://api.github.com/repos/bitcoin-core/gui/issues/643/events",
    "html_url": "https://github.com/bitcoin-core/gui/issues/643",
    "number": 643,
    "state": "open",
    "state_reason": null,
    "title": "deadlock with wrong system date/time and non-empty wallet",
    "body": "I have encountered a deadlock in bitcoin-qt on Manjaro Linux IF you have a wrong system date (enough to trigger this message - \"Please check that your computer's date and time are correct!\") AND if your wallet is not empty. It seems it tries to read transactions in:\r\n\r\n```\r\nTransactionRecord *index(interfaces::Wallet& wallet, int idx)\r\n{\r\n...\r\n            if (wallet.tryGetTxStatus(rec->hash, wtx, numBlocks, adjustedTime) && rec->statusUpdateNeeded(numBlocks)) {\r\n                rec->updateStatus(wtx, numBlocks, adjustedTime);\r\n}\r\n```\r\nwhile displaying the warning message box and somehow deadlocks cs_nTimeOffset. The effect is that the message box pop-ups but you cannot click it and program does not react in any way.\r\n\r\nMoved from bitcoin/bitcoin#15598.",
    "user": {
      "login": "hebasto",
      "id": 32963518,
      "node_id": "MDQ6VXNlcjMyOTYzNTE4",
      "avatar_url": "https://avatars.githubusercontent.com/u/32963518?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/hebasto",
      "html_url": "https://github.com/hebasto",
      "followers_url": "https://api.github.com/users/hebasto/followers",
      "following_url": "https://api.github.com/users/hebasto/following%7B/other_user%7D",
      "gists_url": "https://api.github.com/users/hebasto/gists%7B/gist_id%7D",
      "starred_url": "https://api.github.com/users/hebasto/starred%7B/owner%7D%7B/repo%7D",
      "subscriptions_url": "https://api.github.com/users/hebasto/subscriptions",
      "organizations_url": "https://api.github.com/users/hebasto/orgs",
      "repos_url": "https://api.github.com/users/hebasto/repos",
      "events_url": "https://api.github.com/users/hebasto/events%7B/privacy%7D",
      "received_events_url": "https://api.github.com/users/hebasto/received_events",
      "type": "User",
      "site_admin": false
    },
    "labels": [
      {
        "id": 2140649117,
        "node_id": "MDU6TGFiZWwyMTQwNjQ5MTE3",
        "url": "https://api.github.com/repos/bitcoin-core/gui/labels/Bug",
        "name": "Bug",
        "description": "Something isn't working",
        "color": "d73a4a",
        "default": false
      }
    ],
    "assignees": [],
    "author_association": "MEMBER",
    "locked": false,
    "comments": 2,
    "created_at": "2022-08-06T10:57:14Z",
    "updated_at": "2023-05-05T14:10:58Z"
  },
  "events": [
    {
      "event": "labeled",
      "id": 7140822537,
      "node_id": "LE_lADOEEET9c5PUTLXzwAAAAGpoE4J",
      "url": "https://api.github.com/repos/bitcoin-core/gui/issues/events/7140822537",
      "actor": {
        "login": "hebasto",
        "id": 32963518,
        "node_id": "MDQ6VXNlcjMyOTYzNTE4",
        "avatar_url": "https://avatars.githubusercontent.com/u/32963518?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/hebasto",
        "html_url": "https://github.com/hebasto",
        "followers_url": "https://api.github.com/users/hebasto/followers",
        "following_url": "https://api.github.com/users/hebasto/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/hebasto/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/hebasto/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/hebasto/subscriptions",
        "organizations_url": "https://api.github.com/users/hebasto/orgs",
        "repos_url": "https://api.github.com/users/hebasto/repos",
        "events_url": "https://api.github.com/users/hebasto/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/hebasto/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2022-08-06T10:57:14Z",
      "label": {
        "name": "Bug",
        "color": "d73a4a"
      }
    },
    {
      "event": "commented",
      "id": 1351808973,
      "node_id": "IC_kwDOEEET9c5QkvfN",
      "url": "https://api.github.com/repos/bitcoin-core/gui/issues/comments/1351808973",
      "actor": {
        "login": "john-moffett",
        "id": 116917595,
        "node_id": "U_kgDOBvgFWw",
        "avatar_url": "https://avatars.githubusercontent.com/u/116917595?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/john-moffett",
        "html_url": "https://github.com/john-moffett",
        "followers_url": "https://api.github.com/users/john-moffett/followers",
        "following_url": "https://api.github.com/users/john-moffett/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/john-moffett/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/john-moffett/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/john-moffett/subscriptions",
        "organizations_url": "https://api.github.com/users/john-moffett/orgs",
        "repos_url": "https://api.github.com/users/john-moffett/repos",
        "events_url": "https://api.github.com/users/john-moffett/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/john-moffett/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2022-12-14T17:19:43Z",
      "updated_at": "2022-12-14T21:24:19Z",
      "author_association": "CONTRIBUTOR",
      "body": "I've managed to track this down.\r\n\r\n### Summary:\r\n\r\nThe warning box call holds `g_timeoffset_mutex` (with `msghand` thread) but waits on the `main/gui` thread. Another thread holds `cs_main` and waits on `g_timeoffset_mutex`. The `main/gui` thread then calls a scheduled polling event which waits for  `cs_main`. This prevents the user from releasing the `g_timeoffset_mutex`, since they can no longer press \"OK\" on the warning box.\r\n\r\n### Details:\r\n\r\nThe warning box gets [called](https://github.com/bitcoin-core/gui/blob/678889e6c6231cf461de59eefe6fb8eb07468848/src/timedata.cpp#L93-L98) from `AddTimeData` in the `msghand` thread while it holds the `g_timeoffset_mutex` lock. The call is [blocking](https://github.com/bitcoin-core/gui/blob/7d515600034b84ebf23346a3642cf0a714880e25/src/qt/guiutil.cpp#L369-L379), so it doesn't get released until the user presses \"OK\". That means it has to wait on the `main/gui` thread.\r\n\r\nWhile that's happening, the `scheduler` thread [locks](https://github.com/bitcoin-core/gui/blob/678889e6c6231cf461de59eefe6fb8eb07468848/src/net_processing.cpp#L5086) `cs_main` and eventually tries to lock `g_timeoffset_mutex` (via `GetAdjustedTime`):\r\n\r\nhttps://github.com/bitcoin-core/gui/blob/678889e6c6231cf461de59eefe6fb8eb07468848/src/net_processing.cpp#L1239-L1242\r\n\r\nIt can't, so it waits.\r\n\r\nMeanwhile, `WalletModel::pollBalanceChanged` gets called on the `main/gui` thread since it's on a scheduled timer. It checks to see if the confirmation numbers in the wallet need to be updated (this is why you need a non-empty wallet). Eventually, this line is called (similar to the now-outdated version in the OP):\r\n\r\nhttps://github.com/bitcoin-core/gui/blob/678889e6c6231cf461de59eefe6fb8eb07468848/src/qt/transactiontablemodel.cpp#L228\r\n\r\nIn [`tryGetTxStatus`](https://github.com/bitcoin-core/gui/blob/7d515600034b84ebf23346a3642cf0a714880e25/src/wallet/interfaces.cpp#L347), the `findBlock` method [waits](https://github.com/bitcoin-core/gui/blob/7d515600034b84ebf23346a3642cf0a714880e25/src/node/interfaces.cpp#L558) on `cs_main` (which is held by the `scheduler` thread, which is waiting on `g_timeoffset_mutex`). Now we can't release the `g_timeoffset_mutex` by pressing \"OK\" since the `main/gui` thread is blocked.\r\n\r\n### Root Issue:\r\n\r\nThe fundamental issue is that the `uiInterface.ThreadSafeMessageBox` (and related `ThreadSafeQuestion`, `InitError`, and `InitWarning`) calls are blocking _but wait on the GUI thread_. If `ThreadSafeMessageBox` is called while any locks are held, and the `main/gui` thread subsequently waits on those same locks, it'll freeze. Here's a dumb example -- add this to `walletcontroller.cpp`:\r\n\r\n```\r\nvoid LoadWalletsActivity::load()\r\n{\r\n    std::thread ([] {\r\n        LOCK(cs_main);\r\n        InitWarning(_(\"Everything is now frozen\"));\r\n    }).detach();\r\n```\r\n\r\nBut what's happening in this issue is a bit more insidious, as the `main/gui` is waiting on `cs_main`, yet only `g_timeoffset_mutex` is directly locked by the `ThreadSafeMessageBox` call. \r\n\r\n### Potential fixes:\r\n\r\nI can't think of a simple but comprehensive fix. There are a few potential fixes to this specific case. For instance, in `AddTimeData`, we could temporarily release the lock before calling `ThreadSafeMessageBox`. Alternatively, we could call `ThreadSafeMessageBox` in its own thread. Or have a non-blocking version that avoids using the deadlock-prone `Qt::BlockingQueuedConnection`. I've tried all these and they do fix the issue, but I may be overlooking a better solution.\r\n\r\nIt looks like @ariard and @ryanofsky had a [discussion](https://github.com/bitcoin/bitcoin/pull/17954#discussion_r372726164) somewhat related to this, so maybe can give better ideas than mine.",
      "user": {
        "login": "john-moffett",
        "id": 116917595,
        "node_id": "U_kgDOBvgFWw",
        "avatar_url": "https://avatars.githubusercontent.com/u/116917595?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/john-moffett",
        "html_url": "https://github.com/john-moffett",
        "followers_url": "https://api.github.com/users/john-moffett/followers",
        "following_url": "https://api.github.com/users/john-moffett/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/john-moffett/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/john-moffett/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/john-moffett/subscriptions",
        "organizations_url": "https://api.github.com/users/john-moffett/orgs",
        "repos_url": "https://api.github.com/users/john-moffett/repos",
        "events_url": "https://api.github.com/users/john-moffett/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/john-moffett/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin-core/gui/issues/643#issuecomment-1351808973",
      "issue_url": "https://api.github.com/repos/bitcoin-core/gui/issues/643"
    },
    {
      "event": "mentioned",
      "id": 8039567638,
      "node_id": "MEE_lADOEEET9c5PUTLXzwAAAAHfMhEW",
      "url": "https://api.github.com/repos/bitcoin-core/gui/issues/events/8039567638",
      "actor": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2022-12-14T17:19:44Z"
    },
    {
      "event": "subscribed",
      "id": 8039567648,
      "node_id": "SE_lADOEEET9c5PUTLXzwAAAAHfMhEg",
      "url": "https://api.github.com/repos/bitcoin-core/gui/issues/events/8039567648",
      "actor": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2022-12-14T17:19:44Z"
    },
    {
      "event": "mentioned",
      "id": 8039567666,
      "node_id": "MEE_lADOEEET9c5PUTLXzwAAAAHfMhEy",
      "url": "https://api.github.com/repos/bitcoin-core/gui/issues/events/8039567666",
      "actor": {
        "login": "ariard",
        "id": 23310655,
        "node_id": "MDQ6VXNlcjIzMzEwNjU1",
        "avatar_url": "https://avatars.githubusercontent.com/u/23310655?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ariard",
        "html_url": "https://github.com/ariard",
        "followers_url": "https://api.github.com/users/ariard/followers",
        "following_url": "https://api.github.com/users/ariard/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ariard/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ariard/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ariard/subscriptions",
        "organizations_url": "https://api.github.com/users/ariard/orgs",
        "repos_url": "https://api.github.com/users/ariard/repos",
        "events_url": "https://api.github.com/users/ariard/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ariard/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2022-12-14T17:19:44Z"
    },
    {
      "event": "subscribed",
      "id": 8039567674,
      "node_id": "SE_lADOEEET9c5PUTLXzwAAAAHfMhE6",
      "url": "https://api.github.com/repos/bitcoin-core/gui/issues/events/8039567674",
      "actor": {
        "login": "ariard",
        "id": 23310655,
        "node_id": "MDQ6VXNlcjIzMzEwNjU1",
        "avatar_url": "https://avatars.githubusercontent.com/u/23310655?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ariard",
        "html_url": "https://github.com/ariard",
        "followers_url": "https://api.github.com/users/ariard/followers",
        "following_url": "https://api.github.com/users/ariard/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ariard/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ariard/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ariard/subscriptions",
        "organizations_url": "https://api.github.com/users/ariard/orgs",
        "repos_url": "https://api.github.com/users/ariard/repos",
        "events_url": "https://api.github.com/users/ariard/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ariard/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2022-12-14T17:19:44Z"
    },
    {
      "event": "commented",
      "id": 1536322254,
      "node_id": "IC_kwDOEEET9c5bkmrO",
      "url": "https://api.github.com/repos/bitcoin-core/gui/issues/comments/1536322254",
      "actor": {
        "login": "RandyMcMillan",
        "id": 152159,
        "node_id": "MDQ6VXNlcjE1MjE1OQ==",
        "avatar_url": "https://avatars.githubusercontent.com/u/152159?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/RandyMcMillan",
        "html_url": "https://github.com/RandyMcMillan",
        "followers_url": "https://api.github.com/users/RandyMcMillan/followers",
        "following_url": "https://api.github.com/users/RandyMcMillan/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/RandyMcMillan/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/RandyMcMillan/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/RandyMcMillan/subscriptions",
        "organizations_url": "https://api.github.com/users/RandyMcMillan/orgs",
        "repos_url": "https://api.github.com/users/RandyMcMillan/repos",
        "events_url": "https://api.github.com/users/RandyMcMillan/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/RandyMcMillan/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-05-05T14:10:58Z",
      "updated_at": "2023-05-05T14:10:58Z",
      "author_association": "CONTRIBUTOR",
      "body": "I vaguely remember finding a solution to this... I will try to find it - buried in a comment somewhere in bitcoin/bitcoin issues. \r\n\r\nIf I recall - the fix had to do with (re)casting the time back to int when passing it to the gui. The gui wasnt handling the chronos? variable correctly - it was likely a bug in the QT gui framework itself. I wasnt able to \"prove\" it because the crash didnt produce a stack error (for the gui) - but it worked. :)\r\n\r\nI will try repost the fix with some tests to prove this...",
      "user": {
        "login": "RandyMcMillan",
        "id": 152159,
        "node_id": "MDQ6VXNlcjE1MjE1OQ==",
        "avatar_url": "https://avatars.githubusercontent.com/u/152159?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/RandyMcMillan",
        "html_url": "https://github.com/RandyMcMillan",
        "followers_url": "https://api.github.com/users/RandyMcMillan/followers",
        "following_url": "https://api.github.com/users/RandyMcMillan/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/RandyMcMillan/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/RandyMcMillan/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/RandyMcMillan/subscriptions",
        "organizations_url": "https://api.github.com/users/RandyMcMillan/orgs",
        "repos_url": "https://api.github.com/users/RandyMcMillan/repos",
        "events_url": "https://api.github.com/users/RandyMcMillan/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/RandyMcMillan/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin-core/gui/issues/643#issuecomment-1536322254",
      "issue_url": "https://api.github.com/repos/bitcoin-core/gui/issues/643"
    }
  ]
}